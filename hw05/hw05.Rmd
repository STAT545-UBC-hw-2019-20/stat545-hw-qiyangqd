---
title: "Homework 05"
author: "Qi Yang"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r load, warning = FALSE, message = FALSE}
library(tidyverse)
library(tidyr)
library(gapminder)
library(DT)
library(forcats)
library(here)
library(gridExtra)
```

## Exercise 1: Explain the value of the here::here package
- One value I found about `here::here` before reading the blog is that it is great for people to run others' codes at their own computer. It doesn't use a path that only exist in the creator's computer. 
- After reading the blog, I found more values about this package.

## Exercise 2: Factor management
### Elaboration for the gapminder data set
1. Drop Oceania.
1) The variables we are going to use are `continent` and `country`. According to the requirement, I need to ensure that they are factors:
```{r}
class(gapminder$continent)
class(gapminder$country)
```
They are indeed factors.     
2) Now I am going to `filter` the gapminder dataset: remove observations associated with the `continent` of Oceania.     
- Before filtering:    
```{r}
nlevels(gapminder$continent)
levels(gapminder$continent)
nrow(gapminder)
```
There are 5 levels in `continent` and  rows in gapminder.     
- After filtering:     
```{r}
gap_fd_oce <- gapminder %>% 
              filter(continent != "Oceania")
nlevels(gap_fd_oce$continent)
levels(gap_fd_oce$continent)
nrow(gap_fd_oce)
```
Although we did remove some rows of data of Oceania, the level 'Oceania' still exists.
3) Now I am going to remove Oceania, the unused factor level.
```{r}
gap_dp_oce <- gap_fd_oce %>% 
              droplevels()
nlevels(gap_dp_oce$continent)
levels(gap_dp_oce$continent)
```
Now the level Oceania has been removed.
2.Reorder the levels of `country` or `continent`.
In this task, I am going to use the factor `country`. What I aim to do is to see how GDP (= `gdpPercap`*`pop` in `gapminder`) changes over time (the summary statistic) in the top 5 countries which have the highest GDP in 2019, according to [GDP Ranked by Country 2019](http://worldpopulationreview.com/countries/countries-by-gdp/).   
1) Create a new dataset: `gapGDP`.
```{r}
# choose 5 countries
top5gdp <- c("United States", "China", "Japan", "Germany", "India")
# modify gapminder
gapGDP <- gapminder %>% 
  mutate(GDP = gdpPercap*pop/1000000000) %>% # create GDP column
  select(country, GDP, year) %>% # choose variables
  filter(country %in% top5gdp) %>% 
  mutate_if(is.numeric, round) # round the digits of GDP
```
2) Compare the results of `arrange` on the original and re-leveled factor.  
- Original:
```{r}
gapGDP %>% 
  DT::datatable()
```
Countries are listed alphabetically: China, Germany, India, Japan, United States.     
- Re-leveled:
```{r}
gapGDP %>% 
  group_by(country) %>% 
  mutate(maxGDP = max(GDP)) %>% 
  arrange(desc(maxGDP)) %>% 
  select(-maxGDP) %>% 
  DT::datatable()
```
Now the countries are arranged in a descending order of their maximum GDP. I did this so that it is consistent with my after-re-leveling plot below.        
3) Plot figures of before/after re-leveling the factor.      
```{r}
p_befRel <- ggplot(gapGDP, aes(x = year, y = GDP, # plot before re-leveling
                  color = country)) + 
  geom_line(size = 0.8) +
  labs(x = "Year", y = "GDP (billion dollar)", color = "Country") +
  theme_bw()

p_aftRel <- ggplot(gapGDP, aes(x = year, y = GDP, # plot after relevling
                  color = fct_reorder2(country, year, GDP, max))) + 
                        # fct_reorder2 is used for 2 variables
  geom_line(size = 0.8) +
  labs(x = "Year", y = "GDP (billion dollar)", color = "Country") +
  theme_bw()
```
```{r, fig.height=5, fig.width=10}
grid.arrange(p_befRel, p_aftRel, ncol = 2, nrow = 1) # side-by-side
```
- Before re-leveling (left):     

It is a little inconvenient to look at the plot. For example, if I want to know which country had the highest GDP, I have to remeber the color of the line and find the country name with the same color in the legend.  

- After re-leveling (right):    

The orders of countries are the same in both legend and graph. When looking at the lines, we can move our eyes horizontally to the legend, instead of searching in the legend from top to bottom to find the corresponding country!

## Exercise 3: File input/output (I/O)
1) Create something new.      

In this task, I want to see if life expectancies of each continent in the most recent year (2007) varied. I checked maximum values at first, but there isn't much difference. So let's check out minimum values.
```{r}
gaplifeExp_con <- gapminder %>% 
                  filter(year == "2007") %>% 
                  group_by(continent) %>% 
                  summarise(lifeExpmin = min(lifeExp))
DT::datatable(gaplifeExp_con)
```
2) Export dataset to disk, and reload it back            

- Export:
```{r}
write_csv(gaplifeExp_con, here::here("hw05","gaplifeExp_con.csv"))
```
- Reload:
```{r}
gaplifeExp_con_re <- read_csv(here::here("hw05", "gaplifeExp_con.csv"))
DT::datatable(gaplifeExp_con_re)
```
Comment: I didn't have any difficulty writing to file and then reading it back. The new file looked just the same as before. I guess it is because the dataset didn't have much data (only 2 columns and 5 rows).     
3) Order my data with my factor
I am going to demonstrate the ordering of my data (`gaplifeExp_con_re`) by plots.     
```{r}
gaplifeExp_con_re %>%
  ggplot() +
  geom_col(aes(x = fct_reorder(continent, lifeExpmin), y = lifeExpmin)) +
  theme_bw() +
  labs(x = "Continent", y = "Minimum life expectancy")
```
The continents are plotted in a ascending order of minimum life expectancy. We can see that there indeed were differences. The lowest life expectancy took place in Africa (< 40 years old), and the highest existed in Oceania (> 80 years old).   

## Exercise 4: Visualization design
In this task, I have picked 3 plots I created in my assignment before to modify them.     

1. Changes of life expectancy over time on different continents (Homework03, Task Option 5)
```{r}
hw03_old <- gapminder %>% # old plot
  group_by(continent, year) %>% 
  summarize(min = min(lifeExp),
            mean = mean(lifeExp),
            max = max(lifeExp)) %>% 
  ggplot(aes(year, mean, colour = continent)) +
  geom_line()+
  geom_point()+
  scale_x_continuous("Year")+
  scale_y_continuous("Mean of life expectancy")+
  theme_light()+
  scale_color_brewer(palette="Paired", name = "Continent")

hw03_new <- gapminder %>% # new plot
  group_by(continent, year) %>% 
  summarise(meanlifeExp = mean(lifeExp)) %>% 
ggplot(aes(year, meanlifeExp,
                  color = fct_reorder2(continent, year, meanlifeExp))) + 
  geom_line(size = 0.6) +
  labs(x = "Year", y = "Mean of life expectancy", color = "Continent") +
  theme_classic()
```
```{r, fig.height=5, fig.width=15}
grid.arrange(hw03_old, hw03_new, ncol = 2, nrow = 1)
```
<center> Changes of life expectancy over time on different continents, old(left) and new (right) </center>

|What I changed|Oldl|New|
|----|--------|---|
|factor re-leveling| Orders of continents don't match in lines and legend | Matched!|
|Color| Colors are not very obvious | easy to differentiate from each other|
|Background|Grids in graph are kind of distractive|White, lines are easier to be seen|
|Points|Could be redundant|Removed as the general trend matters most|

2. Changes of GDP per capita in each continent over time (Homework 02, Exercise 2)

```{r}
hw02_old <- ggplot(gapminder, aes(gdpPercap, color = continent)) +
  geom_line(stat = "density", size = 0.8) +
  scale_x_log10("GDP per capita", labels = scales::dollar_format())+
  scale_y_continuous("Density")+
  theme_light()+
  scale_color_brewer(palette="Set1", name = "Continent")

hw02_new <- ggplot(gapminder, aes(gdpPercap, continent) )+
  ggridges::geom_density_ridges()+
  theme_classic()+
  scale_x_continuous("GDP per capita", labels = scales::dollar_format())+
  scale_y_discrete("Continent")
```
```{r, fig.height=5, fig.width=15}
grid.arrange(hw02_old, hw02_new, ncol = 2, nrow = 1)
```
|What I changed|Original|New|
|----|--------|---|
|plot type| Kind of messy and hard to pick a continent out to see its density | Continents' density plots separated and easy to be seen|
|Background|Grids in graph are kind of distractive|White, density plots are easier to be seen|
|Color|Actually it is fine|Since `continent` becomes the y-axis there is no need for colors: things are simpler and help viewers to concentrate on the shape of each plot|


|What I changed|Oldl|New|
|----|--------|---|
|plot type| Kind of messy, hard to pick out a continent's density plot| Continents are separated and easy to be seen|
|Background|Grids in graph are kind of distractive|White, density plots are easier to be seen|
|x-axis scale|`scale_x_log10` might cause misunderstanding|Default `scale_x_continuous`, prevent misunderstanding |
|Color|Actually it is fine | As `continent` becomes the y-axis there is no need for colors: the plot becomes simpler and helps viewers to concentrate on the density shape|


## Exercise 5: Writing figures to file

